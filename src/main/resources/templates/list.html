<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title>Webflux Demo App</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
	crossorigin="anonymous">
<script th:inline="javascript">
		class SensorDataStream {
			start() {
				const buildTableData = (data) => {
					return `<tr>
									<td>${data.timestamp}</td>
									<td>${data.metadata.sensorId}</td>
									<td>${data.metadata.type}</td>
									<td>${data.value}</td>
								 </tr>`;
				}
		
				const tbody = document.getElementById("sensorData");
		
				this.socket = new WebSocket([['ws:/localhost:8080/'+@{ws/stream}]]);
				
				this.socket.onopen = (event) => this.socket.send("Socket offen!");
				
				this.socket.onmessage = (event) => {
				    let data = JSON.parse(event.data);
					tbody.innerHTML = buildTableData(data) + tbody.innerHTML;
				};
			}
			
			stop () {
                if (this.socket)
                	this.socket.close();
            }
		}

		const stream = new SensorDataStream();
        window.onload = () => stream.start();
        window.onbeforeunload =() => stream.stop();
</script>
</head>
<body class="p-2">
	<header>
		<h1>Sensor Data</h1>
	</header>
	<main>
		<table class="table table-striped">
			<thead>
				<tr>
					<th>Timestamp</th>
					<th>Sensor ID</th>
					<th>Sensor Type</th>
					<th>Value</th>
				</tr>
			</thead>
			<tbody id="sensorData">
			</tbody>
		</table>
	</main>
	<footer class="text-center">Â©2035 by WebTech Inc. - Made with
		Spring Webflux, Thymeleaf, MongoDB and Node.js</footer>
</body>
</html>